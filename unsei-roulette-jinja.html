<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>運勢ルーレット神社</title>
  <style>
:root{
  --bg1:#070815;
  --bg2:#0b1230;

  --ink:#eef0ff;
  --muted:rgba(238,240,255,.72);

  --stroke:rgba(255,255,255,.12);
  --shadow: 0 18px 60px rgba(0,0,0,.55);
  --radius: 22px;

  --gold:#ffd26b;
  --gold2:#ffb84a;
  --gold3:#fff1b8;
  --crimson:#ff3b6a;
  --ok:#6effb0;
  --blue:#78a0ff;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  color:var(--ink);
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
  background:
    radial-gradient(1200px 800px at 20% 10%, rgba(255,210,107,.16), transparent 55%),
    radial-gradient(900px 700px at 80% 15%, rgba(255,59,106,.14), transparent 55%),
    radial-gradient(900px 900px at 60% 90%, rgba(110,255,176,.10), transparent 60%),
    linear-gradient(160deg, var(--bg1), var(--bg2));
  overflow-x:hidden;
}

.wrap{ width:min(980px, 92vw); margin: 22px auto 40px; }

/* Hero */
.hero{
  position:relative;
  padding: 18px;
  border-radius: var(--radius);
  background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.03));
  border: 1px solid var(--stroke);
  box-shadow: var(--shadow);
  text-align:center;
  overflow:hidden;
}
.hero::before{
  content:"";
  position:absolute; inset:-2px;
  background:
    radial-gradient(800px 220px at 50% 0%, rgba(255,210,107,.18), transparent 60%),
    radial-gradient(700px 240px at 70% 20%, rgba(255,59,106,.13), transparent 62%);
  pointer-events:none;
}
.crest{
  position:absolute;
  left: 50%;
  top: -90px;
  width: 260px; height: 260px;
  transform: translateX(-50%);
  background:
    conic-gradient(from 90deg,
      rgba(255,210,107,.0),
      rgba(255,210,107,.22),
      rgba(255,255,255,.08),
      rgba(255,59,106,.18),
      rgba(110,255,176,.12),
      rgba(255,210,107,.0)
    );
  border-radius: 999px;
  filter: blur(1px);
  opacity:.85;
  animation: crest 8s linear infinite;
  pointer-events:none;
}
@keyframes crest{ to{ transform: translateX(-50%) rotate(360deg); } }

.title{
  position:relative;
  margin:0;
  font-weight: 950;
  letter-spacing:.10em;
  text-shadow: 0 2px 0 rgba(0,0,0,.25), 0 18px 30px rgba(0,0,0,.35);
}
.subtitle{ position:relative; margin:6px 0 0; color: var(--muted); font-size: 14px; }

/* Layout */
.panel{
  margin-top: 16px;
  display:grid;
  grid-template-columns: 1.2fr .8fr;
  gap: 14px;
}
@media (max-width: 820px){
  .panel{grid-template-columns:1fr}
}

.stage{
  position:relative;
  border-radius: var(--radius);
  background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.04));
  border: 1px solid var(--stroke);
  box-shadow: var(--shadow);
  padding: 18px;
  overflow:hidden;
  min-height: 560px;
  isolation:isolate;
}

/* 背景演出（クリック阻害禁止） */
.bg-grid, .godrays, .sparkles, .mist, .flash, .confetti, .particles{
  position:absolute;
  inset:0;
  pointer-events:none;
}

.bg-grid{
  background:
    linear-gradient(transparent, rgba(255,255,255,.05)),
    repeating-linear-gradient(90deg, rgba(255,255,255,.06) 0 1px, transparent 1px 22px),
    repeating-linear-gradient(0deg, rgba(255,255,255,.035) 0 1px, transparent 1px 22px);
  opacity:.12;
  mix-blend-mode: overlay;
  filter: blur(.2px);
}

.godrays{
  opacity:.45;
  background:
    conic-gradient(from 0deg at 50% 48%,
      rgba(255,210,107,.0),
      rgba(255,210,107,.14),
      rgba(255,255,255,.04),
      rgba(255,59,106,.10),
      rgba(110,255,176,.06),
      rgba(255,210,107,.0)
    );
  mask: radial-gradient(circle at 50% 48%, #000 0 42%, transparent 66%);
  animation: rays 10s linear infinite;
  filter: blur(.5px);
}
@keyframes rays{ to{ transform: rotate(360deg); } }

.mist{
  background:
    radial-gradient(600px 240px at 30% 30%, rgba(255,210,107,.10), transparent 60%),
    radial-gradient(560px 260px at 70% 55%, rgba(255,59,106,.09), transparent 62%),
    radial-gradient(700px 340px at 50% 90%, rgba(120,160,255,.08), transparent 60%);
  opacity:.9;
  filter: blur(10px);
  mix-blend-mode: screen;
}

.sparkles::before{
  content:"";
  position:absolute; inset:-30%;
  background:
    radial-gradient(circle, rgba(255,255,255,.8) 0 1px, transparent 2px) 0 0/140px 140px,
    radial-gradient(circle, rgba(255,210,107,.8) 0 1px, transparent 2px) 40px 30px/160px 160px,
    radial-gradient(circle, rgba(255,59,106,.65) 0 1px, transparent 2px) 10px 60px/190px 190px;
  opacity:.25;
  animation: twinkle 6s ease-in-out infinite;
  filter: blur(.2px);
}
@keyframes twinkle{
  0%,100%{ transform: translateY(0px); opacity:.18; }
  50%{ transform: translateY(-10px); opacity:.30; }
}

/* ポインター（矢） */
.pointer{
  position:absolute;
  left:50%;
  top: 34px;
  transform: translateX(-50%);
  width: 26px;
  height: 88px;
  z-index: 8;
  filter: drop-shadow(0 18px 20px rgba(0,0,0,.55));
}
.pointer-head{
  position:absolute;
  left:50%;
  top: 0;
  transform: translateX(-50%);
  width: 0; height: 0;
  border-left: 18px solid transparent;
  border-right:18px solid transparent;
  border-bottom: 32px solid rgba(255,210,107,.98);
}
.pointer-body{
  position:absolute;
  left:50%;
  top: 30px;
  transform: translateX(-50%);
  width: 10px; height: 52px;
  border-radius: 99px;
  background: linear-gradient(180deg, rgba(255,210,107,.95), rgba(255,184,74,.65));
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.16);
}
.pointer-shine{
  position:absolute;
  left:50%;
  top: 10px;
  transform: translateX(-50%);
  width: 14px;
  height: 78px;
  border-radius: 99px;
  background: linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,0));
  opacity:.45;
}

/* ホイール */
.wheel-wrap{
  position:relative;
  display:grid;
  place-items:center;
  margin: 36px auto 10px;
  width: min(440px, 92%);
  aspect-ratio: 1 / 1;
  z-index: 2;
}

.ring{
  position:absolute;
  border-radius: 999px;
  pointer-events:none;
}
.ring-outer{
  inset: -10px;
  background:
    conic-gradient(from 90deg,
      rgba(255,210,107,.00),
      rgba(255,210,107,.26),
      rgba(255,255,255,.10),
      rgba(255,59,106,.20),
      rgba(110,255,176,.12),
      rgba(255,210,107,.00)
    );
  filter: blur(1px);
  opacity:.65;
  animation: ring 12s linear infinite;
}
.ring-inner{
  inset: 18px;
  background:
    conic-gradient(from 270deg,
      rgba(255,255,255,.00),
      rgba(255,255,255,.10),
      rgba(255,210,107,.18),
      rgba(255,255,255,.00)
    );
  opacity:.55;
  animation: ring 9s linear infinite reverse;
}
@keyframes ring{ to{ transform: rotate(360deg); } }

.wheel{
  position:relative;
  width: 100%;
  height: 100%;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.16);
  box-shadow:
    inset 0 0 0 12px rgba(255,255,255,.045),
    inset 0 0 40px rgba(0,0,0,.35),
    0 28px 70px rgba(0,0,0,.55);
  background:
    radial-gradient(circle at 20% 20%, rgba(255,255,255,.10), transparent 40%),
    radial-gradient(circle at 80% 30%, rgba(255,255,255,.06), transparent 45%),
    conic-gradient(
      rgba(255,210,107,.98) 0 72deg,
      rgba(255,59,106,.90) 72deg 144deg,
      rgba(110,255,176,.90) 144deg 216deg,
      rgba(120,160,255,.88) 216deg 288deg,
      rgba(255,255,255,.22) 288deg 360deg
    );
  transform: rotate(0deg);
  will-change: transform;
}

.wheel::before{
  content:"";
  position:absolute; inset: 12px;
  border-radius: 999px;
  background:
    radial-gradient(circle at 30% 25%, rgba(255,255,255,.22), transparent 45%),
    radial-gradient(circle at 70% 60%, rgba(255,210,107,.14), transparent 55%),
    radial-gradient(circle at 50% 50%, rgba(0,0,0,.30), rgba(0,0,0,.12) 55%, transparent 70%);
  pointer-events:none;
}

.wheel::after{
  content:"";
  position:absolute; inset: 0;
  border-radius: 999px;
  background:
    radial-gradient(220px 160px at 50% 8%, rgba(255,255,255,.18), transparent 60%),
    radial-gradient(260px 200px at 50% 92%, rgba(0,0,0,.28), transparent 65%);
  mix-blend-mode: overlay;
  pointer-events:none;
}

.rim-shine{
  position:absolute;
  inset: -4px;
  border-radius: 999px;
  background:
    conic-gradient(from 0deg,
      rgba(255,255,255,.0),
      rgba(255,255,255,.18),
      rgba(255,255,255,.0),
      rgba(255,210,107,.22),
      rgba(255,255,255,.0)
    );
  filter: blur(1px);
  opacity:.55;
  animation: rim 5.2s ease-in-out infinite;
}
@keyframes rim{
  0%,100%{ transform: rotate(8deg); opacity:.35; }
  50%{ transform: rotate(18deg); opacity:.70; }
}

/* ラベル */
.label{
  position:absolute;
  left:50%; top:50%;
  transform-origin: 0 0;
  font-weight: 950;
  letter-spacing:.12em;
  color: rgba(10,10,20,.86);
  text-shadow: 0 2px 0 rgba(255,255,255,.20), 0 12px 20px rgba(0,0,0,.15);
  user-select:none;
  font-size: clamp(18px, 3.2vw, 24px);
}
.label.l0{ transform: rotate(-90deg) translate(0, -158px) rotate(90deg); }
.label.l1{ transform: rotate(-18deg) translate(0, -158px) rotate(18deg); }
.label.l2{ transform: rotate(54deg)  translate(0, -158px) rotate(-54deg); }
.label.l3{ transform: rotate(126deg) translate(0, -158px) rotate(-126deg); }
.label.l4{ transform: rotate(198deg) translate(0, -158px) rotate(-198deg); }

.wheel-center{
  position:absolute;
  left:50%; top:50%;
  transform: translate(-50%,-50%);
  width: 92px;
  height: 92px;
  border-radius: 999px;
  background:
    radial-gradient(circle at 30% 25%, rgba(255,255,255,.40), rgba(255,255,255,.12) 45%, rgba(0,0,0,.30));
  border: 1px solid rgba(255,255,255,.18);
  box-shadow: 0 18px 30px rgba(0,0,0,.40);
  display:grid;
  place-items:center;
}
.center-gem{
  width: 44px; height: 44px;
  border-radius: 16px;
  background:
    radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), rgba(255,210,107,.35) 45%, rgba(255,59,106,.20));
  border: 1px solid rgba(255,255,255,.18);
  transform: rotate(12deg);
  box-shadow: 0 10px 18px rgba(0,0,0,.25);
  animation: gem 3.2s ease-in-out infinite;
}
@keyframes gem{
  0%,100%{ transform: rotate(12deg) translateY(0px); }
  50%{ transform: rotate(12deg) translateY(-2px); }
}

/* 結果 */
.result{
  position:relative;
  z-index: 3;
  text-align:center;
  font-size: clamp(60px, 6vw, 88px);
  font-weight: 950;
  margin: 14px 0 4px;
  letter-spacing:.10em;
  text-shadow: 0 2px 0 rgba(0,0,0,.35), 0 26px 55px rgba(0,0,0,.55);
}
.tagline{
  position:relative;
  z-index:3;
  text-align:center;
  color: var(--muted);
  font-size: 14px;
  margin-bottom: 10px;
}

.meta{
  position:relative;
  z-index:3;
  display:flex;
  flex-wrap:wrap;
  gap: 10px;
  justify-content:center;
  margin-top: 10px;
}
.chip{
  padding: 9px 12px;
  border-radius: 999px;
  background: rgba(255,255,255,.07);
  border: 1px solid rgba(255,255,255,.14);
  color: rgba(238,240,255,.90);
  font-size: 13px;
  backdrop-filter: blur(12px);
}

/* Controls */
.controls{
  position:relative;
  border-radius: var(--radius);
  background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
  border: 1px solid var(--stroke);
  box-shadow: var(--shadow);
  padding: 18px;
  overflow:hidden;
}
.controls::before{
  content:"";
  position:absolute; inset:-2px;
  background:
    radial-gradient(520px 300px at 50% 0%, rgba(255,210,107,.18), transparent 60%),
    radial-gradient(520px 280px at 60% 40%, rgba(255,59,106,.14), transparent 62%);
  pointer-events:none;
}

.btn{
  position:relative;
  z-index: 5;
  width: 100%;
  padding: 14px 14px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.14);
  background: linear-gradient(180deg, rgba(255,210,107,.98), rgba(255,184,74,.86));
  color: #2b1a00;
  font-weight: 950;
  letter-spacing:.18em;
  cursor:pointer;
  box-shadow: 0 12px 24px rgba(255,184,74,.16), 0 22px 55px rgba(0,0,0,.35);
  transition: transform .12s ease, filter .12s ease;
  user-select:none;
}
.btn:active{ transform: translateY(1px) scale(.995); filter: brightness(.98); }
.btn:disabled{ opacity:.55; cursor:not-allowed; filter:saturate(.6); }
.btn .btn-glow{
  position:absolute; inset:-2px;
  border-radius: 18px;
  background:
    radial-gradient(220px 90px at 25% 20%, rgba(255,255,255,.40), transparent 60%),
    radial-gradient(260px 120px at 70% 10%, rgba(255,255,255,.25), transparent 65%);
  mix-blend-mode: overlay;
  pointer-events:none;
}

.btn.sub{
  margin-top: 10px;
  background: rgba(255,255,255,.08);
  color: rgba(238,240,255,.92);
  letter-spacing:.10em;
}

.options{ margin-top: 12px; display:flex; justify-content:flex-end; }
.toggle{
  display:flex; gap:10px; align-items:center;
  font-size: 13px; color: rgba(238,240,255,.84);
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.12);
  padding: 8px 10px;
  border-radius: 999px;
}
.toggle input{ transform: translateY(1px); }

.hint{
  position:relative;
  z-index:2;
  margin: 12px 0 0;
  color: var(--muted);
  font-size: 12.5px;
  line-height: 1.55;
}
.hint .em{ color: var(--gold); font-weight: 950; }

.foot{
  text-align:center;
  margin-top: 14px;
  color: rgba(238,240,255,.55);
}

/* エフェクト */
.flash{
  opacity:0;
  background:
    radial-gradient(260px 220px at 50% 38%, rgba(255,255,255,.65), transparent 65%),
    radial-gradient(520px 320px at 50% 38%, rgba(255,210,107,.25), transparent 70%);
  mix-blend-mode: screen;
}
.stage.is-flash .flash{
  animation: flash .7s ease-out forwards;
}
@keyframes flash{
  0%{opacity:0; transform: scale(.96);}
  25%{opacity:1; transform: scale(1);}
  100%{opacity:0; transform: scale(1.05);}
}

.confetti{
  z-index: 9;
}
.confetti i{
  position:absolute;
  top:-10%;
  width: 10px;
  height: 14px;
  border-radius: 3px;
  opacity: .9;
  filter: drop-shadow(0 10px 10px rgba(0,0,0,.25));
}

.particles{
  z-index: 4;
}
.particles i{
  position:absolute;
  width: 6px; height: 6px;
  border-radius: 999px;
  background: rgba(255,255,255,.85);
  filter: blur(.2px) drop-shadow(0 8px 10px rgba(0,0,0,.25));
  opacity:.0;
}

/* 状態 */
.stage.is-jackpot{
  outline: 2px solid rgba(255,210,107,.25);
  box-shadow:
    var(--shadow),
    0 0 0 10px rgba(255,210,107,.05),
    0 0 80px rgba(255,210,107,.14);
}
.result.is-daikichi{
  background: linear-gradient(90deg, var(--gold), var(--gold3), var(--gold2));
  -webkit-background-clip:text;
  background-clip:text;
  color: transparent;
  text-shadow: 0 0 26px rgba(255,210,107,.20), 0 26px 55px rgba(0,0,0,.55);
}
.result.is-kyou{
  color:#ffb0c2;
  text-shadow: 0 0 20px rgba(255,59,106,.18), 0 26px 55px rgba(0,0,0,.55);
}

/* ポインター小刻み（カチカチ感） */
.pointer.is-tick{
  animation: tick .09s ease-out;
}
@keyframes tick{
  0%{ transform: translateX(-50%) rotate(0deg); }
  50%{ transform: translateX(-50%) rotate(-10deg); }
  100%{ transform: translateX(-50%) rotate(0deg); }
}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="hero">
      <div class="crest" aria-hidden="true"></div>
      <h1 class="title">運勢ルーレット神社</h1>
      <p class="subtitle">矢が指した運勢が、今日のあなた。</p>
    </header>

    <main class="panel">
      <section class="stage" aria-label="ルーレット">
        <div class="bg-grid" aria-hidden="true"></div>
        <div class="godrays" aria-hidden="true"></div>
        <div class="sparkles" aria-hidden="true"></div>
        <div class="mist" aria-hidden="true"></div>

        <div class="pointer" aria-hidden="true">
          <div class="pointer-head"></div>
          <div class="pointer-body"></div>
          <div class="pointer-shine"></div>
        </div>

        <div class="wheel-wrap">
          <div class="ring ring-outer" aria-hidden="true"></div>
          <div class="ring ring-inner" aria-hidden="true"></div>

          <div id="wheel" class="wheel" aria-hidden="true">
            <span class="label l0">大吉</span>
            <span class="label l1">中吉</span>
            <span class="label l2">小吉</span>
            <span class="label l3">末吉</span>
            <span class="label l4">凶</span>

            <div class="wheel-center" aria-hidden="true">
              <div class="center-gem" aria-hidden="true"></div>
            </div>
          </div>

          <div class="rim-shine" aria-hidden="true"></div>
        </div>

        <div id="result" class="result" role="status" aria-live="polite">？</div>
        <div id="tagline" class="tagline">回して運勢を引こう</div>

        <div class="meta">
          <div class="chip" id="luckyItem">ラッキーアイテム：—</div>
          <div class="chip" id="oneWord">ひとこと：—</div>
        </div>

        <div id="flash" class="flash" aria-hidden="true"></div>
        <div id="confetti" class="confetti" aria-hidden="true"></div>
        <div id="particles" class="particles" aria-hidden="true"></div>
      </section>

      <section class="controls" aria-label="操作">
        <button id="spinBtn" class="btn" type="button">
          <span class="btn-glow" aria-hidden="true"></span>
          回す
        </button>
        <button id="resetBtn" class="btn sub" type="button">リセット</button>

        <div class="options">
          <label class="toggle">
            <input id="soundToggle" type="checkbox" checked>
            <span>効果音</span>
          </label>
        </div>

        <p class="hint">
          針（矢）が指した運勢が当たり。<span class="em">大吉</span>は神演出！
        </p>
      </section>
    </main>

    <footer class="foot"><small>© Unsei Roulette Jinja</small></footer>
  </div>

  <script>
  const fortunes = ["大吉","中吉","小吉","末吉","凶"];
  const SEG = 360 / fortunes.length;

  const luckyItems = ["赤いペン","白いハンカチ","新しい靴下","温かいお茶","散歩","メモ帳","イヤホン","塩むすび","マグカップ","キーホルダー","香りの良いハンドクリーム","お守り袋"];
  const oneWords = [
    "焦るな、流れは来ている。",
    "今日は小さな親切が運を呼ぶ。",
    "背筋を伸ばせ。顔が変わる。",
    "先に片づけろ。あとが楽だ。",
    "迷ったら“やる”が正解。",
    "休むのも仕事。深呼吸。",
    "口に出した言葉が現実になる。",
    "一歩だけ前へ。十分だ。",
    "連絡は早めに。得をする。",
    "今日の勝ちは、継続から生まれる。"
  ];

  const stage = document.querySelector(".stage");
  const wheel = document.getElementById("wheel");
  const pointer = document.querySelector(".pointer");
  const resultEl = document.getElementById("result");
  const taglineEl = document.getElementById("tagline");
  const luckyEl = document.getElementById("luckyItem");
  const wordEl  = document.getElementById("oneWord");
  const spinBtn = document.getElementById("spinBtn");
  const resetBtn= document.getElementById("resetBtn");
  const confettiEl = document.getElementById("confetti");
  const particlesEl = document.getElementById("particles");
  const soundToggle = document.getElementById("soundToggle");

  let spinning = false;
  let currentDeg = 0;

  function pickRandom(arr){ return arr[Math.floor(Math.random() * arr.length)]; }
  function normalizeDeg(d){ d = d % 360; if(d < 0) d += 360; return d; }

  function clearResultClasses(){
    resultEl.classList.remove("is-daikichi","is-kyou");
    stage.classList.remove("is-jackpot");
  }
  function getIndexFromRotation(deg){
    const r = normalizeDeg(deg);
    const pointerAngle = normalizeDeg(-r);
    const shifted = normalizeDeg(pointerAngle + SEG/2);
    return Math.floor(shifted / SEG);
  }

  (function injectKF(){
    if(document.getElementById("fxKF")) return;
    const style = document.createElement("style");
    style.id = "fxKF";
    style.textContent = `
      @keyframes fall{
        0%{ transform: translateY(-20px) translateX(0px) rotate(0deg); opacity: 0; }
        10%{ opacity: .95; }
        100%{ transform: translateY(620px) translateX(var(--drift)) rotate(720deg); opacity: 0; }
      }
      @keyframes floatUp{
        0%{ transform: translateY(12px) scale(.9); opacity:0; }
        25%{ opacity:.85; }
        100%{ transform: translateY(-160px) scale(1.1); opacity:0; }
      }
    `;
    document.head.appendChild(style);
  })();

  function spawnConfetti(amount = 50){
    confettiEl.innerHTML = "";
    const w = stage.clientWidth;
    const colors = [
      "rgba(255,210,107,.95)",
      "rgba(255,59,106,.9)",
      "rgba(110,255,176,.9)",
      "rgba(255,255,255,.85)",
      "rgba(120,160,255,.85)"
    ];
    for(let i=0;i<amount;i++){
      const p = document.createElement("i");
      const left = Math.random() * w;
      const delay = Math.random() * 0.22;
      const dur = 1.0 + Math.random() * 1.1;
      const drift = (Math.random()*300 - 150);
      p.style.left = left + "px";
      p.style.background = colors[Math.floor(Math.random()*colors.length)];
      p.style.animation = `fall ${dur}s ease-in ${delay}s forwards`;
      p.style.setProperty("--drift", drift + "px");
      confettiEl.appendChild(p);
    }
  }

  function spawnParticles(amount = 16){
    particlesEl.innerHTML = "";
    const w = stage.clientWidth;
    const h = stage.clientHeight;
    for(let i=0;i<amount;i++){
      const dot = document.createElement("i");
      const x = w * (0.15 + Math.random()*0.7);
      const y = h * (0.55 + Math.random()*0.25);
      const size = 3 + Math.random()*5;
      const delay = Math.random()*0.25;
      const dur = 0.9 + Math.random()*0.8;

      dot.style.left = x + "px";
      dot.style.top = y + "px";
      dot.style.width = size + "px";
      dot.style.height = size + "px";
      dot.style.background = Math.random() < .7 ? "rgba(255,210,107,.92)" : "rgba(255,255,255,.85)";
      dot.style.animation = `floatUp ${dur}s ease-out ${delay}s forwards`;
      dot.style.opacity = "0";
      particlesEl.appendChild(dot);
    }
  }

  function flash(){
    stage.classList.remove("is-flash");
    stage.getBoundingClientRect();
    stage.classList.add("is-flash");
    setTimeout(()=>stage.classList.remove("is-flash"), 800);
  }

  function tickPointer(){
    pointer.classList.remove("is-tick");
    pointer.getBoundingClientRect();
    pointer.classList.add("is-tick");
    setTimeout(()=>pointer.classList.remove("is-tick"), 120);
  }

  let audioCtx = null;
  function ensureAudio(){
    if(!soundToggle.checked) return null;
    if(!audioCtx){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if(audioCtx.state === "suspended"){
      audioCtx.resume();
    }
    return audioCtx;
  }
  function playTick(){
    const ctx = ensureAudio();
    if(!ctx) return;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    const f = 700 + Math.random()*500;

    o.type = "triangle";
    o.frequency.setValueAtTime(f, ctx.currentTime);
    g.gain.setValueAtTime(0.0, ctx.currentTime);
    g.gain.linearRampToValueAtTime(0.08, ctx.currentTime + 0.005);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.06);

    o.connect(g).connect(ctx.destination);
    o.start();
    o.stop(ctx.currentTime + 0.07);
  }
  function playBell(){
    const ctx = ensureAudio();
    if(!ctx) return;
    const base = 520 + Math.random()*40;
    const freqs = [base, base*2.01, base*2.51];
    freqs.forEach((fr, idx)=>{
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "sine";
      o.frequency.setValueAtTime(fr, ctx.currentTime);
      g.gain.setValueAtTime(0.0, ctx.currentTime);
      g.gain.linearRampToValueAtTime(0.12/(idx+1), ctx.currentTime + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 1.2 + idx*0.15);
      o.connect(g).connect(ctx.destination);
      o.start();
      o.stop(ctx.currentTime + 1.4 + idx*0.2);
    });
  }

  function setUIBeforeSpin(){
    clearResultClasses();
    resultEl.textContent = "…";
    taglineEl.textContent = "神託が降りるまで…";
    luckyEl.textContent = "ラッキーアイテム：—";
    wordEl.textContent  = "ひとこと：—";
    confettiEl.innerHTML = "";
    particlesEl.innerHTML = "";
  }

  function applyResult(fortune){
    resultEl.textContent = fortune;
    spawnParticles(18);
    flash();

    if(fortune === "大吉"){
      resultEl.classList.add("is-daikichi");
      stage.classList.add("is-jackpot");
      spawnConfetti(95);
      taglineEl.textContent = "祝福の光が降り注ぐ…！";
      playBell();
    }else if(fortune === "凶"){
      resultEl.classList.add("is-kyou");
      spawnConfetti(35);
      taglineEl.textContent = "今日は守りに徹せよ…";
      playBell();
    }else{
      spawnConfetti(55);
      taglineEl.textContent = "流れは悪くない。淡々といこう。";
      playBell();
    }

    luckyEl.textContent = `ラッキーアイテム：${pickRandom(luckyItems)}`;
    wordEl.textContent  = `ひとこと：${pickRandom(oneWords)}`;
  }

  function spin(){
    if(spinning) return;
    spinning = true;

    spinBtn.disabled = true;
    resetBtn.disabled = true;

    ensureAudio();
    setUIBeforeSpin();

    const spins = 6 + Math.floor(Math.random()*4);
    const target = currentDeg + spins*360 + Math.random()*360;

    wheel.style.transition = "transform 3200ms cubic-bezier(.10,.92,.14,1)";
    wheel.style.transform = `rotate(${target}deg)`;

    let ticks = 0;
    const tickTimer = setInterval(()=>{
      ticks++;
      tickPointer();
      playTick();
      if(ticks > 18) clearInterval(tickTimer);
    }, 120);

    const onDone = () => {
      wheel.removeEventListener("transitionend", onDone);
      clearInterval(tickTimer);

      currentDeg = target;
      const idx = getIndexFromRotation(currentDeg);
      const fortune = fortunes[idx];
      applyResult(fortune);

      spinBtn.disabled = false;
      resetBtn.disabled = false;
      spinning = false;
    };
    wheel.addEventListener("transitionend", onDone, { once:true });
  }

  function resetAll(){
    if(spinning) return;
    currentDeg = 0;
    wheel.style.transition = "transform 0ms";
    wheel.style.transform = "rotate(0deg)";
    clearResultClasses();
    resultEl.textContent = "？";
    taglineEl.textContent = "回して運勢を引こう";
    luckyEl.textContent = "ラッキーアイテム：—";
    wordEl.textContent  = "ひとこと：—";
    confettiEl.innerHTML = "";
    particlesEl.innerHTML = "";
  }

  spinBtn.addEventListener("click", spin);
  resetBtn.addEventListener("click", resetAll);
  resetAll();
  </script>
</body>
</html>
